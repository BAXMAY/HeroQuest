/**
 * @file Firestore Security Rules for Deeds & Cheers.
 * @description This ruleset enforces a strict user-ownership model for user data and volunteer work submissions,
 *              and uses a dedicated collection to manage approver roles.
 * @dataStructure
 *   /users/{userId}: Stores private user profiles, accessible only to the owning user.
 *   /users/{userId}/volunteerWork/{volunteerWorkId}: Stores volunteer work submissions, accessible only to the owning user.
 *   /roles_approver/{approverId}:  A list of approved users for approving submitted volunteer work.
 *   /leaderboardEntries/{leaderboardEntryId}: Stores leaderboard entries, with read access granted to anyone.
 * @keySecurityDecisions
 *   - Users can only access their own data and volunteer work submissions.
 *   - Approver roles are managed through a dedicated collection; presence in the collection grants approver privileges.
 *   - Leaderboard entries are publicly readable.
 *   - Listing of users is explicitly denied.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles, allowing only the owner to read and write their own data.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     * @allow (get, update, delete) User with ID 'user123' can read, update, and delete their profile.
     * @deny (create, get, update, delete) User with ID 'user456' cannot access user 'user123' data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects volunteer work submissions, allowing only the owner to read and write their own submissions.
     * @path /users/{userId}/volunteerWork/{volunteerWorkId}
     * @allow (create) User with ID 'user123' can create a volunteer work submission.
     * @allow (get, update, delete) User with ID 'user123' can read, update, and delete their own submission.
     * @deny (create, get, update, delete) User with ID 'user456' cannot access user 'user123' submissions.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/volunteerWork/{volunteerWorkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages approver roles, allowing read access to all and write access only to existing approvers.
     * @path /roles_approver/{approverId}
     * @allow (get, list) Anyone can read the list of approvers.
     * @allow (create, update, delete) Only existing approvers can create, update or delete approvers.
     * @principle Uses existence in the collection to grant approver privileges.
     */
    match /roles_approver/{approverId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add approver validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add approver validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add approver validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to leaderboard entries.
     * @path /leaderboardEntries/{leaderboardEntryId}
     * @allow (get, list) Anyone can read leaderboard entries.
     * @deny (create, update, delete) Only approvers can modify leaderboard entries.
     * @principle Grants public read access while restricting write access.
     */
    match /leaderboardEntries/{leaderboardEntryId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add approver validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add approver validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add approver validation once the schema is updated with an ownership field.
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}